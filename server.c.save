#include <stdio.h>
#include <netdb.h>
#include <netinet/in.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdbool.h>
#include <unistd.h>

#include <pthread.h>


#define PORT 2301

#define MAX_CLIENTS 10
int clients[MAX_CLIENTS]; // Tableau pour stocket les sockets des clients connect√©s
pthreads_mutex_t clients_mutex = PTHRADS_MUTEX_INITIALIZER; // Pour proteger l'acces au tableau



void end_if_error(bool error_condition, char *msg) {
    if (error_condition) {
        perror(msg);
        exit(EXIT_FAILURE);
    }
}


int main (int argc, char *argv[]) {
    int s, connec, ret, yes = 1;
    socklen_t len;
    struct sockaddr_in server_addr, client_addr;
    char buf[100];
    char *answer = "Hello, client!";

    //create a tcp socket
    s = socket(AF_INET, SOCK_STREAM, 0);
    end_if_error(s == -1, "socket");

    //bind it to my server address
    ret = setsockopt(s, SOL_SOCKET, SO_REUSEADDR, &yes, sizeof(yes));
    end_if_error(ret == -1, "reuseaddr");
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(PORT);
    server_addr.sin_addr.s_addr = INADDR_ANY;
    ret = bind(s, (struct sockaddr *)&server_addr, sizeof(server_addr));
    end_if_error(ret == -1, "bind");

    //set this socket as a passive socket that will be used to accept connections
    ret = listen(s, 10);
    end_if_error(ret == -1, "listen");

    //wait for a connection and accept it
    len = sizeof(client_addr);
    memset(&client_addr, 0, len);
    connec = accept(s, (struct sockaddr *)&client_addr, &len);
    end_if_error(connec < 0, "accept");

    //we have a connection! receive and then send a message
    ret = read(connec, buf, sizeof(buf));
    end_if_error(ret <= 0, "read");

    printf("Server received messaged %s\n", buf);
    ret = write(connec, answer, strlen(answer)+1);
    end_if_error(ret != strlen(answer)+1,"write");

    //close and end
    close(s);

    return EXIT_SUCCESS;
}

